"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[371],{2371:(t,e,i)=>{i.d(e,{MapEditorScene:()=>a}),i(1367);var s=i(662),o=i(2042);class a extends Phaser.Scene{preload(){this.createTileTextures()}createTileTextures(){this.textures.exists("tileset_sprites")||this.textures.addSpriteSheet("tileset_sprites",this.textures.get("tileset").getSourceImage(),{frameWidth:32,frameHeight:32,startFrame:0,endFrame:63})}create(){console.log("\uD83D\uDDFAÔ∏è MapEditorScene started!"),this.mapSystem=new s.A(this),this.physics.world.setBounds(0,0,4128,800),this.createBackground(),this.tilemapSystem=new o.W(this),this.tilemapSystem.createCollisionBodies(),this.createGridOverlay(),this.loadDefaultMap(),this.createEditorUI(),this.setupCamera(),this.setupInput(),this.createPreviewObjects()}loadDefaultMap(){this.isLoadingCustomMap}createBackground(){let t="background1",e=this.textures.get(t).source[0].width,i=Math.max(4100/e,800/this.textures.get(t).source[0].height);this.backgroundImage=this.add.image(e*i/2,400,t),this.backgroundImage.setScrollFactor(.3),this.backgroundImage.setDepth(-10),this.backgroundImage.setScale(i),this.darkOverlay=this.add.rectangle(2050,400,4100,800,0,.4),this.darkOverlay.setScrollFactor(.2),this.darkOverlay.setDepth(1)}createGridOverlay(){this.gridGraphics=this.add.graphics(),this.gridGraphics.setDepth(5),this.gridGraphics.lineStyle(1,65280,.3);let t=this.tilemapSystem.tileSize,e=this.tilemapSystem.mapWidth,i=this.tilemapSystem.mapHeight;for(let s=0;s<=e;s++){let e=s*t;this.gridGraphics.moveTo(e,0),this.gridGraphics.lineTo(e,i*t)}for(let s=0;s<=i;s++){let i=s*t;this.gridGraphics.moveTo(0,i),this.gridGraphics.lineTo(e*t,i)}this.gridGraphics.strokePath()}createEditorUI(){this.add.text(50,30,"Map Editor",{fontSize:"24px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2}).setScrollFactor(0),this.add.text(50,60,"Select a tool first, then click to place objects | Right-click to remove | Drag to paint tiles",{fontSize:"12px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:1}).setScrollFactor(0),this.createToolSelection(),this.createMapButtons(),this.createObjectInfo(),this.createGridToggle();let t=this.add.text(50,280,"Press T to open tile selector",{fontSize:"12px",fill:"#ffff00",fontStyle:"bold",stroke:"#000000",strokeThickness:1}).setScrollFactor(0),e=this.add.text(50,300,"Press H to hide/show HUD",{fontSize:"12px",fill:"#ffff00",fontStyle:"bold",stroke:"#000000",strokeThickness:1}).setScrollFactor(0);this.hudElements.push(t,e)}createToolSelection(){this.selectedTool=null,this.selectedSpriteIndex=null,this.toolButtons=[],[{name:"Player",key:"player",color:"#00ff00"},{name:"Portal",key:"portal",color:"#ff00ff"},{name:"Enemy1",key:"enemy1",color:"#ff0000"},{name:"Enemy2",key:"enemy2",color:"#ff8800"},{name:"Solid",key:"solid",color:"#8B4513"},{name:"Erase",key:"erase",color:"#000000"}].forEach((t,e)=>{let i=this.add.text(50+e%4*120,100+30*Math.floor(e/4),t.name,{fontSize:"12px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2,backgroundColor:this.selectedTool===t.key?t.color:"#444444",padding:{x:8,y:4}}).setScrollFactor(0).setInteractive();i.on("pointerdown",()=>{"solid"===t.key?this.openSpritePicker():(this.selectedTool=t.key,this.selectedSpriteIndex=null,this.updateToolSelection())}),"solid"===t.key&&(this.solidButtonSprite=this.add.image(i.x+50,i.y,"tileset_sprites",0),this.solidButtonSprite.setScrollFactor(0),this.solidButtonSprite.setDisplaySize(24,24),this.solidButtonSprite.setDepth(i.depth+1)),this.toolButtons.push({button:i,tool:t})}),this.toolButtons.forEach(t=>{let{button:e}=t;this.hudElements.push(e)}),this.solidButtonSprite&&this.hudElements.push(this.solidButtonSprite)}updateToolSelection(){this.toolButtons.forEach(t=>{let{button:e,tool:i}=t;e.setFill("#ffffff"),e.setBackgroundColor(this.selectedTool===i.key?i.color:"#444444")})}openSpritePicker(){if(this.spritePicker)return void this.closeSpritePicker();this.spritePicker=this.add.rectangle(600,300,400,500,0,.8),this.spritePicker.setScrollFactor(0),this.spritePicker.setDepth(1e3),this.add.text(600,100,"Select Sprite",{fontSize:"18px",fill:"#ffffff",fontStyle:"bold"}).setScrollFactor(0).setDepth(1001).setOrigin(.5),this.spriteButtons=[];for(let t=0;t<64;t++){let e=440+t%8*40,i=150+40*Math.floor(t/8),s=this.add.image(e,i,"tileset_sprites",t);s.setScrollFactor(0),s.setDepth(1001),s.setDisplaySize(32,32),s.setInteractive();let o=this.add.rectangle(e,i,36,36,0xffffff,.3);o.setScrollFactor(0),o.setDepth(1e3),s.on("pointerdown",()=>{this.selectedSpriteIndex=t,this.selectedTool="solid",this.updateToolSelection(),this.solidButtonSprite&&this.solidButtonSprite.setFrame(t),this.closeSpritePicker()}),s.on("pointerover",()=>{o.setFillStyle(65280,.5)}),s.on("pointerout",()=>{o.setFillStyle(0xffffff,.3)}),this.spriteButtons.push({sprite:s,border:o})}this.add.text(600,450,"Close",{fontSize:"14px",fill:"#ffffff",fontStyle:"bold",backgroundColor:"#aa0000",padding:{x:10,y:6}}).setScrollFactor(0).setDepth(1001).setOrigin(.5).setInteractive().on("pointerdown",()=>{this.closeSpritePicker()})}closeSpritePicker(){this.spritePicker&&(this.spritePicker.destroy(),this.spritePicker=null),this.spriteButtons&&(this.spriteButtons.forEach(t=>{let{sprite:e,border:i}=t;e.destroy(),i.destroy()}),this.spriteButtons=[]);let t=this.children.list.find(t=>"Close"===t.text&&1001===t.depth);t&&t.destroy();let e=this.children.list.find(t=>"Select Sprite"===t.text&&1001===t.depth);e&&e.destroy()}toggleHUD(){this.hudVisible=!this.hudVisible,this.hudElements.forEach(t=>{t&&t.setVisible(this.hudVisible)})}toggleGrid(){this.gridVisible=!this.gridVisible,this.gridGraphics.setVisible(this.gridVisible),this.gridToggleButton.setText("Grid: ".concat(this.gridVisible?"ON":"OFF")),this.gridToggleButton.setBackgroundColor(this.gridVisible?"#00aa00":"#aa0000")}createMapButtons(){this.saveButton=this.add.text(50,180,"Save Map",{fontSize:"14px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2,backgroundColor:"#00aa00",padding:{x:10,y:6}}).setScrollFactor(0).setInteractive(),this.saveButton.on("pointerdown",()=>{this.saveMap()}),this.loadButton=this.add.text(150,180,"Load Map",{fontSize:"14px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2,backgroundColor:"#0066aa",padding:{x:10,y:6}}).setScrollFactor(0).setInteractive(),this.loadButton.on("pointerdown",()=>{this.loadMap()}),this.clearButton=this.add.text(250,180,"Clear All",{fontSize:"14px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2,backgroundColor:"#aa0000",padding:{x:10,y:6}}).setScrollFactor(0).setInteractive(),this.clearButton.on("pointerdown",()=>{this.clearAll()}),this.backButton=this.add.text(350,180,"Back to Home",{fontSize:"14px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2,backgroundColor:"#0066cc",padding:{x:10,y:6}}).setScrollFactor(0).setInteractive(),this.backButton.on("pointerdown",()=>{this.scene.start("CharacterSelectScene")}),this.hudElements.push(this.saveButton,this.loadButton,this.clearButton,this.backButton)}createObjectInfo(){this.objectInfoText=this.add.text(50,220,"Selected: None - Select a tool",{fontSize:"12px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:1}).setScrollFactor(0),this.coordinateText=this.add.text(50,240,"Position: (0, 0)",{fontSize:"12px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:1}).setScrollFactor(0),this.hudElements.push(this.objectInfoText,this.coordinateText)}createGridToggle(){this.gridVisible=!0,this.gridToggleButton=this.add.text(50,250,"Grid: ON",{fontSize:"12px",fill:"#ffffff",fontStyle:"bold",stroke:"#000000",strokeThickness:2,backgroundColor:"#00aa00",padding:{x:8,y:4}}).setScrollFactor(0).setInteractive(),this.gridToggleButton.on("pointerdown",()=>{this.gridVisible=!this.gridVisible,this.gridGraphics.setVisible(this.gridVisible),this.gridToggleButton.setText("Grid: ".concat(this.gridVisible?"ON":"OFF")),this.gridToggleButton.setBackgroundColor(this.gridVisible?"#00aa00":"#aa0000")}),this.hudElements.push(this.gridToggleButton)}setupCamera(){this.cameras.main.setBounds(0,0,4100,800),this.cameras.main.setZoom(.8),this.cameras.main.centerOn(2050,400),this.cameras.main.setZoom(.8)}setupInput(){this.input.on("pointerdown",t=>{if(this.isClickOnUI(t))return;let e=this.cameras.main.getWorldPoint(t.x,t.y).x,i=this.cameras.main.getWorldPoint(t.x,t.y).y;t.rightButtonDown()?this.removeObjectAt(e,i):(this.placeObject(e,i),this.selectedTool&&["ground","platform","wall","solid","erase"].includes(this.selectedTool)&&(this.isDragging=!0))}),this.input.on("pointermove",t=>{if(this.isDragging&&t.isDown){let e=this.cameras.main.getWorldPoint(t.x,t.y).x,i=this.cameras.main.getWorldPoint(t.x,t.y).y;this.placeObject(e,i)}}),this.input.on("pointerup",()=>{this.isDragging=!1}),this.cursors=this.input.keyboard.createCursorKeys(),this.wasdKeys=this.input.keyboard.addKeys("W,S,A,D"),this.input.keyboard.on("keydown-T",()=>{this.openSpritePicker()}),this.input.keyboard.on("keydown-H",()=>{this.toggleHUD()}),this.input.keyboard.on("keydown-G",()=>{this.toggleGrid()}),this.cameraSpeed=10}isClickOnUI(t){if(!this.hudVisible)return!1;for(let e of[{x:40,y:90,width:500,height:80},{x:40,y:170,width:420,height:30},{x:40,y:210,width:300,height:50},{x:40,y:240,width:300,height:80}])if(t.x>=e.x&&t.x<=e.x+e.width&&t.y>=e.y&&t.y<=e.y+e.height)return!0;return!1}createPreviewObjects(){this.previewObjects=[],this.gameObjects=[],this.mouseIndicator=this.add.circle(0,0,5,0xffffff,.8),this.mouseIndicator.setDepth(100),this.mouseIndicator.setVisible(!1)}placeObject(t,e){if(this.selectedTool){switch(this.selectedTool){case"player":this.updatePlayerPosition(t,e);break;case"portal":this.updatePortalPosition(t,e);break;case"enemy1":case"enemy2":this.addEnemy(t,e,this.selectedTool);break;case"ground":case"platform":case"wall":case"solid":this.placeTile(t,e,o.W.TILE_TYPES.SOLID,this.selectedSpriteIndex);break;case"erase":this.eraseTile(t,e)}this.updateObjectInfo()}}removeObjectAt(t,e){this.mapData.enemies=this.mapData.enemies.filter(i=>Phaser.Math.Distance.Between(t,e,i.position.x,i.position.y)>50),this.updatePreviewObjects()}updatePlayerPosition(t,e){this.mapData.player.startPosition.x=Math.round(t),this.mapData.player.startPosition.y=Math.round(e),this.updatePreviewObjects()}updatePortalPosition(t,e){this.mapData.portal.position.x=Math.round(t),this.mapData.portal.position.y=Math.round(e),this.updatePreviewObjects()}addEnemy(t,e,i){let s="enemy_".concat(Date.now());this.mapData.enemies.push({id:s,type:"stationary",enemyType:i,position:{x:Math.round(t),y:Math.round(e)},properties:{damage:20,health:50,maxHealth:50,collisionCooldown:1e3}}),this.updatePreviewObjects()}placeTile(t,e,i){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=this.tilemapSystem.worldToTile(t,e);o.x>=0&&o.x<this.tilemapSystem.mapWidth&&o.y>=0&&o.y<this.tilemapSystem.mapHeight&&this.tilemapSystem.setTile(o.x,o.y,i,s)}eraseTile(t,e){let i=this.tilemapSystem.worldToTile(t,e);i.x>=0&&i.x<this.tilemapSystem.mapWidth&&i.y>=0&&i.y<this.tilemapSystem.mapHeight&&this.tilemapSystem.setTile(i.x,i.y,o.W.TILE_TYPES.EMPTY)}updatePreviewObjects(){this.previewObjects.forEach(t=>t.destroy()),this.previewObjects=[];let t=this.mapData.player.startPosition,e=this.add.circle(t.x,t.y,20,65280,.7);e.setDepth(50),this.previewObjects.push(e);let i=this.mapData.portal.position,s=this.add.circle(i.x,i.y,30,0xff00ff,.7);s.setDepth(50),this.previewObjects.push(s),this.mapData.enemies.forEach(t=>{let e="enemy1"===t.enemyType?0xff0000:0xff8800,i=this.add.circle(t.position.x,t.position.y,15,e,.7);i.setDepth(50),this.previewObjects.push(i)})}updateObjectInfo(){this.objectInfoText.setText("Selected: ".concat(this.selectedTool||"None - Select a tool"))}async saveMap(){this.saveTileDataToMap(),await this.mapSystem.saveMap(this.mapData)?console.log("Map saved successfully"):console.log("Map save cancelled or failed")}saveTileDataToMap(){this.mapData.tiles||(this.mapData.tiles=[]),this.mapData.tiles=[];for(let t=0;t<this.tilemapSystem.mapHeight;t++){this.mapData.tiles[t]=[];for(let e=0;e<this.tilemapSystem.mapWidth;e++){let i=this.tilemapSystem.getTile(e,t),s=this.tilemapSystem.getTileSpriteIndex(e,t);this.mapData.tiles[t][e]={type:i,spriteIndex:s}}}}loadMap(){let t=document.createElement("input");t.type="file",t.accept=".json",t.style.display="none",document.body.appendChild(t),t.addEventListener("change",e=>{var i;let s=null==(i=e.target.files)?void 0:i[0];s&&(this.isLoadingCustomMap=!0,this.mapSystem.loadMap(s).then(t=>{this.mapData=t,this.loadTileDataFromMap(),this.updatePreviewObjects(),this.isLoadingCustomMap=!1}).catch(t=>{console.error("Error loading map:",t),alert("Error loading map: "+t.message),this.isLoadingCustomMap=!1})),document.body.removeChild(t)}),t.click()}async loadMapFromURL(t){console.log("\uD83D\uDD04 Loading map from URL: ".concat(t)),this.isLoadingCustomMap=!0;try{let e=await this.mapSystem.loadMapFromURL(t);return this.mapData=e,this.loadTileDataFromMap(),this.updatePreviewObjects(),this.isLoadingCustomMap=!1,console.log("‚úÖ Map loaded successfully from URL: ".concat(t)),e}catch(t){throw console.error("Error loading map from URL:",t),this.isLoadingCustomMap=!1,t}}loadTileDataFromMap(){var t,e;if(console.log("\uD83D\uDDFAÔ∏è Loading tile data from map: ".concat((null==(t=this.mapData.metadata)?void 0:t.name)||"Unknown")),this.mapData.tiles&&Array.isArray(this.mapData.tiles)){for(let t=0;t<this.tilemapSystem.mapHeight;t++)for(let e=0;e<this.tilemapSystem.mapWidth;e++)this.tilemapSystem.setTile(e,t,o.W.TILE_TYPES.EMPTY);for(let t=0;t<Math.min(this.mapData.tiles.length,this.tilemapSystem.mapHeight);t++)if(this.mapData.tiles[t]&&Array.isArray(this.mapData.tiles[t]))for(let e=0;e<Math.min(this.mapData.tiles[t].length,this.tilemapSystem.mapWidth);e++){let i=this.mapData.tiles[t][e];"number"==typeof i?this.tilemapSystem.setTile(e,t,i):i&&"object"==typeof i&&(this.tilemapSystem.setTile(e,t,i.type,i.spriteIndex),0===e&&t===this.tilemapSystem.mapHeight-1&&console.log("\uD83D\uDD27 Tile changed at first column, last row (".concat(e,", ").concat(t,"): type=").concat(i.type,", spriteIndex=").concat(i.spriteIndex)))}console.log("‚úÖ Tile data loaded successfully. Map dimensions: ".concat(this.mapData.tiles.length," rows x ").concat((null==(e=this.mapData.tiles[0])?void 0:e.length)||0," columns"))}}clearAll(){this.mapData.enemies=[];for(let t=0;t<this.tilemapSystem.mapHeight;t++)for(let e=0;e<this.tilemapSystem.mapWidth;e++)this.tilemapSystem.setTile(e,t,o.W.TILE_TYPES.EMPTY);this.updatePreviewObjects()}update(){(this.cursors.left.isDown||this.wasdKeys.A.isDown)&&(this.cameras.main.scrollX-=this.cameraSpeed),(this.cursors.right.isDown||this.wasdKeys.D.isDown)&&(this.cameras.main.scrollX+=this.cameraSpeed),(this.cursors.up.isDown||this.wasdKeys.W.isDown)&&(this.cameras.main.scrollY-=this.cameraSpeed),(this.cursors.down.isDown||this.wasdKeys.S.isDown)&&(this.cameras.main.scrollY+=this.cameraSpeed);let t=this.input.mousePointer.x,e=this.input.mousePointer.y,i=this.cameras.main.getWorldPoint(t,e).x,s=this.cameras.main.getWorldPoint(t,e).y,o=Math.floor(i/this.tilemapSystem.tileSize),a=Math.floor(s/this.tilemapSystem.tileSize),l=this.tilemapSystem.getTile(o,a),r=this.getTileTypeName(l);this.coordinateText.setText("Position: (".concat(Math.round(i),", ").concat(Math.round(s),") | Tile: (").concat(o,", ").concat(a,") [").concat(r,"]")),this.mouseIndicator&&(this.mouseIndicator.setPosition(i,s),this.mouseIndicator.setVisible(!0))}getTileTypeName(t){switch(t){case o.W.TILE_TYPES.EMPTY:return"Empty";case o.W.TILE_TYPES.SOLID:return"Solid";default:return"Unknown(".concat(t,")")}}constructor(){super({key:"MapEditorScene"}),this.gridVisible=!0,this.hudVisible=!0,this.hudElements=[],this.isLoadingCustomMap=!1,this.selectedTool=null,this.selectedSpriteIndex=null,this.toolButtons=[],this.spritePicker=null,this.spriteButtons=[],this.previewObjects=[],this.gameObjects=[],this.cameraSpeed=10,this.isDragging=!1,this.hudVisible=!0,this.hudElements=[],this.isLoadingCustomMap=!1}}}}]);